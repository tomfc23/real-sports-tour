<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Karma Delta Scraper</title>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <style>
    body { font-family: sans-serif; background: #111; color: #fff; padding: 20px; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #444; padding: 8px; text-align: left; }
    th { background-color: #222; }
    tr:nth-child(even) { background-color: #1a1a1a; }
  </style>
</head>
<body>
  <h1>KarmaDelta Leaderboard</h1>
  <div id="status">Loading...</div>
  <table id="results" style="display:none">
    <thead>
      <tr><th>User</th><th>User ID</th><th>Karma Delta</th></tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ5_4iMe0s46WHziXgAcLGkS7VFMBaNLXndPcpT20b7YSaUTRz_2BTr6NC24XlRF3oHSZAm2fi-RrHV/pub?output=csv';
    const PROXY = 'https://api.allorigins.win/raw?url=';

    async function fetchCSV(url) {
      const res = await axios.get(PROXY + encodeURIComponent(url));
      return res.data;
    }

    function parseCSV(data) {
      const lines = data.trim().split('\n').slice(1); // Skip header
      return lines.map(line => {
        const [user, id] = line.split(',').map(s => s.trim());
        return { user, id };
      });
    }

    async function fetchKarma(userId) {
      try {
        const res = await axios.get(PROXY + encodeURIComponent(`https://api.real.vg/user/${userId}/karmafeed`));
        return res.data.stats.karmaDelta || 0;
      } catch (err) {
        console.error(`Failed to fetch ${userId}:`, err);
        return null;
      }
    }

    async function loadData() {
      document.getElementById('status').innerText = 'Fetching CSV...';
      const rawCSV = await fetchCSV(CSV_URL);
      const users = parseCSV(rawCSV);

      const tbody = document.querySelector('#results tbody');
      let completed = 0;

      for (let i = 0; i < users.length; i++) {
        const { user, id } = users[i];
        const delta = await fetchKarma(id);
        completed++;

        if (delta !== null) {
          const row = document.createElement('tr');
          row.innerHTML = `<td>@${user}</td><td>${id}</td><td>${delta}</td>`;
          tbody.appendChild(row);
        }

        document.getElementById('status').innerText = `Fetched ${completed} of ${users.length}`;
        if (i % 10 === 9) await new Promise(r => setTimeout(r, 350)); // Delay after 10 requests
      }

      document.getElementById('results').style.display = 'table';
      document.getElementById('status').innerText = 'Done.';
    }

    loadData();
  </script>
</body>
</html>
